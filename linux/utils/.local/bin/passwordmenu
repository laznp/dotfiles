#!/bin/bash

# Unlock or reuse Bitwarden session
if [ -z "$BW_SESSION" ]; then
    BW_SESSION=$(bw unlock --raw) || exit 1
    export BW_SESSION
fi

# Sync to ensure the latest data
bw sync --session "$BW_SESSION"

# Retrieve all items and display names in Tofi
items=$(bw list items --session "$BW_SESSION" | jq -r '.[] | "\(.id) \(.name)"')
selection=$(echo "$items" | tofi --prompt-text='ï‚„  ' --config ~/.config/tofi/launcher.config)

# Exit if nothing is selected
[ -z "$selection" ] && exit 1

# Extract item ID from the selection
item_id=$(echo "$selection" | awk '{print $1}')
item=$(bw get item "$item_id" --session "$BW_SESSION")

# Extract username and password
username=$(echo "$item" | jq -r '.login.username')
password=$(echo "$item" | jq -r '.login.password')
cred_name=$(echo "$item" | jq -r '.name')

# Copy password to clipboard (using wl-copy for Wayland)
echo -n "$password" | wl-copy

# Notify the user
notify-send "Bitwarden" "Password for $cred_name copied to clipboard."
