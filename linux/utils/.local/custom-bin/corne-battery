#!/usr/bin/env bash
MAC_ADDR=DE_B4_92_AA_8E_1B # Seeed Xiao
R_KB_PATH=service0015/char0016
L_KB_PATH=service0015/char001b

hex_to_dec_or_sleep() {
  local hexval=$1
  if [[ -z "$hexval" || ! "$hexval" =~ ^[0-9A-Fa-f]+$ ]]; then
    echo "0"
  else
    echo $((16#$hexval))
  fi
}

# Find the correct interface path by checking which hci adapter has the device
INTERFACE_PATH=""
for hci in /sys/class/bluetooth/hci*; do
  hci_name=$(basename "$hci")
  if gdbus introspect --system --dest org.bluez \
    --object-path /org/bluez/${hci_name}/dev_${MAC_ADDR} &>/dev/null; then
    INTERFACE_PATH="$hci_name"
    break
  fi
done

if [[ -z "$INTERFACE_PATH" ]]; then
  echo "󰌌  --% | --% (not connected)"
  exit 1
fi

L_KB_HEX=$(gdbus call --system --dest org.bluez \
  --object-path /org/bluez/$INTERFACE_PATH/dev_$MAC_ADDR/$L_KB_PATH \
  --method org.bluez.GattCharacteristic1.ReadValue "{}" 2>/dev/null \
  | sed -E 's/.*0x([0-9a-fA-F]+).*/\1/')

R_KB_HEX=$(gdbus call --system --dest org.bluez \
  --object-path /org/bluez/$INTERFACE_PATH/dev_$MAC_ADDR/$R_KB_PATH \
  --method org.bluez.GattCharacteristic1.ReadValue "{}" 2>/dev/null \
  | sed -E 's/.*0x([0-9a-fA-F]+).*/\1/')

L_DEC=$(hex_to_dec_or_sleep "$L_KB_HEX")
R_DEC=$(hex_to_dec_or_sleep "$R_KB_HEX")

echo "󰌌  $L_DEC% | $R_DEC%"
