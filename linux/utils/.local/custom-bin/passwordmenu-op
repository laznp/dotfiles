#!/bin/bash

# Choose password manager
manager=$(printf "Bitwarden\n1Password" | rofi -dmenu -p "üîê Select Manager" -i -theme ~/.config/rofi/config)
[ -z "$manager" ] && exit 0

# Item selection
case "$manager" in
  Bitwarden)
    items=$(rbw ls)
    selection=$(echo "$items" | rofi -dmenu -p "ÔÇÑ  Bitwarden" -theme ~/.config/rofi/config -i)
    ;;
  1Password)
    items=$(op item list --format=json | jq -r '.[].title' | sort)
    selection=$(echo "$items" | rofi -dmenu -p "ÔÇÑ  1Password" -theme ~/.config/rofi/config -i)
    ;;
  *)
    notify-send "Password Manager" "Invalid selection."
    exit 1
    ;;
esac

[ -z "$selection" ] && exit 0

# Choose field
field=$(printf "Username\nTOTP\nPassword" | rofi -dmenu \
  -theme ~/.config/rofi/card_square.rasi \
  -selected-row 1 \
  -theme-str 'window { width: 15em; }' \
  -no-sort -no-lazy-grab -no-history)

[ -z "$field" ] && exit 0

# Retrieve and copy to clipboard
case "$manager" in
  Bitwarden)
    case "$field" in
      Username)
        value=$(rbw get "$selection" --field username)
        ;;
      Password)
        value=$(rbw get "$selection")
        ;;
      TOTP)
        value=$(rbw get "$selection" --field totp)
        ;;
    esac
    ;;
  1Password)
    item_id=$(op item list --format=json | jq -r --arg title "$selection" '.[] | select(.title == $title) | .id')
    [ -z "$item_id" ] && notify-send "1Password" "Failed to find item ID." && exit 1
    case "$field" in
      Username)
        value=$(op item get "$item_id" --format=json | jq -r '.fields[]? | select(.id == "username" or .label == "username") | .value')
        ;;
      Password)
        value=$(op item get "$item_id" --format=json | jq -r '.fields[]? | select(.id == "password" or .label == "password") | .value')
        ;;
      TOTP)
        value=$(op item get "$item_id" --otp)
        ;;
    esac
    ;;
esac

[ -z "$value" ] && notify-send "$manager" "No value found for $field." && exit 1

# Copy to clipboard (X11)
echo -n "$value" | xclip -selection clipboard

# Notify
notify-send "$manager" "$field for $selection copied to clipboard."
